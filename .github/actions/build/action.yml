name: 'Cache, and Build'
description: 'Cache NuGet packages and build data, and build a .NET project using msbuild'

inputs:
  configuration:
    description: 'Build configuration'
    required: true
    default: 'Release'
  force_restore:
    description: 'Force restore NuGet packages'
    required: false
    default: false

runs:
  using: "composite"
  steps:
    - name: Get current week
      id: get_week
      run: echo "::set-output name=week::$(date +'%Y-%U')"
      shell: pwsh

    - name: Cache NuGet packages
      uses: actions/cache@v3
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}-${{ steps.get_week.outputs.week }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Cache build data
      uses: actions/cache@v3
      with:
        path: |
          **/bin
          **/obj
        key: ${{ runner.os }}-build-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-build-

    - name: Setup .NET
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: '6.0.x'

    - name: Restore NuGet packages
      run: |
        if (${{ inputs.force_restore }}) {
          msbuild -t:restore --force
        } else {
          msbuild -t:restore
        }
      shell: pwsh

    - name: Build solution
      run: msbuild -p:Configuration=${{ inputs.configuration }}
      shell: pwsh
